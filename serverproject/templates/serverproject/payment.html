{% extends 'serverproject/base.html' %}

{% block title %}Complete Payment{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-16 text-center">
    <h1 class="text-3xl font-bold">Complete Your Payment</h1>
    <p class="mt-4 text-lg">You are about to pay â‚¹{{ order.get_total_cost }} for order #{{ order.id }}.</p>
    <p>Click the button below to proceed with Razorpay.</p>

    <div id="payment-button-container" class="mt-8">
        <button id="rzp-button1" class="btn btn-primary btn-lg">Pay with Razorpay</button>
    </div>

    <div id="payment-status" class="mt-4"></div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
    var options = {
        "key": "{{ razorpay_key_id }}",
        "amount": "{{ amount }}", 
        "currency": "INR",
        "name": "BellServer",
        "description": "VPS Plan Purchase",
        "image": "https://www.bellglobal.in/wp-content/uploads/2021/02/New-Logo-BellGlobal.png",
        "order_id": "{{ razorpay_order_id }}",
        "handler": function (response){
            var statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = '<p class="text-blue-500">Verifying payment...</p>';

            fetch('{% url "payment_verification" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature
                })
            }).then(function(response) {
                return response.json();
            }).then(function(data) {
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = data.redirect_url;
                }
            }).catch(function(error) {
                statusDiv.innerHTML = '<p class="text-red-500">An error occurred during payment verification. Please contact support.</p>';
            });
        },
        "prefill": {
            "name": "{{ order.first_name }} {{ order.last_name }}",
            "email": "{{ order.email }}",
            "contact": ""
        },
        "notes": {
            "address": "{{ order.address }}"
        },
        "theme": {
            "color": "#3399cc"
        },
        "modal": {
            "ondismiss": function(){
                window.location.href = "{% url 'payment_cancelled' order.id %}";
            }
        }
    };
    var rzp1 = new Razorpay(options);
    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    }
    </script>
</div>
{% endblock %}
